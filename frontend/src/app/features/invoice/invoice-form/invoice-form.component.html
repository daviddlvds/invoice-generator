<div class="min-h-screen bg-gradient-to-br from-bg-page to-slate-100 py-8 pb-64">
  <div class="w-full flex justify-center mb-8">
    <h1
      class="
        text-4xl sm:text-5xl
        font-extrabold
        tracking-tight
        text-slate-900
        bg-clip-text
        text-transparent
        bg-gradient-to-r from-primary to-indigo-600
      "
    >
      Invoice Generator
    </h1>
  </div>

  <form
    [formGroup]="form"
    class="
      w-full
      max-w-full
      sm:max-w-2xl
      lg:max-w-4xl
      xl:max-w-6xl
      mx-auto
      space-y-6
      bg-bg-card
      rounded-2xl
      shadow-md
      border
      border-border-soft
      overflow-hidden
    "
  >
    <div
      *ngIf="apiErrorMessage"
      class="max-w-full sm:max-w-2xl lg:max-w-4xl xl:max-w-6xl mx-auto mb-4"
    >
      <div class="rounded-xl border border-red-200 bg-red-50 p-4">
        <div class="flex items-start gap-3">
          <span class="material-symbols-outlined text-red-600">error</span>

          <div class="flex-1">
            <p class="font-semibold text-red-800">
              {{ apiErrorMessage }}
            </p>

            <ul *ngIf="apiErrorDetails.length" class="mt-2 list-disc pl-5 text-sm text-red-700 space-y-1">
              <li *ngFor="let d of apiErrorDetails">{{ d }}</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- =========================
         REQUIRED FIELDS LIST
    ========================== -->
    <div class="p-5 bg-white border-b border-border-soft">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-xs font-bold uppercase tracking-wider text-primary">
            Required fields
          </h3>
          <p class="text-xs text-slate-500 mt-1">
            All fields are required. Complete everything to generate the PDF.
          </p>
        </div>

        <span
          class="inline-flex items-center gap-2 text-xs font-semibold px-3 py-1.5 rounded-full
                 border border-border-soft bg-bg-soft text-slate-600"
        >
          <span class="material-symbols-outlined text-base">checklist</span>
          All required
        </span>
      </div>

      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <div class="rounded-xl border border-border-soft bg-bg-soft p-3">
          <div class="text-[10px] uppercase font-bold text-slate-500">Your Business</div>
          <ul class="mt-2 text-xs text-slate-600 space-y-1 list-disc list-inside">
            <li>Company Name <span class="text-red-500 font-bold">*</span></li>
            <li>Email <span class="text-red-500 font-bold">*</span></li>
            <li>Website <span class="text-red-500 font-bold">*</span></li>
            <li>Street Address <span class="text-red-500 font-bold">*</span></li>
            <li>Country <span class="text-red-500 font-bold">*</span></li>
            <li>ZIP Code <span class="text-red-500 font-bold">*</span></li>
          </ul>
        </div>

        <div class="rounded-xl border border-border-soft bg-bg-soft p-3">
          <div class="text-[10px] uppercase font-bold text-slate-500">Bill To</div>
          <ul class="mt-2 text-xs text-slate-600 space-y-1 list-disc list-inside">
            <li>Client Name <span class="text-red-500 font-bold">*</span></li>
            <li>Client Address <span class="text-red-500 font-bold">*</span></li>
            <li>Client Email <span class="text-red-500 font-bold">*</span></li>
            <li>Country <span class="text-red-500 font-bold">*</span></li>
            <li>City/State/ZIP <span class="text-red-500 font-bold">*</span></li>
          </ul>
        </div>

        <div class="rounded-xl border border-border-soft bg-bg-soft p-3">
          <div class="text-[10px] uppercase font-bold text-slate-500">Invoice</div>
          <ul class="mt-2 text-xs text-slate-600 space-y-1 list-disc list-inside">
            <li>At least 1 item <span class="text-red-500 font-bold">*</span></li>
            <li>Item Type <span class="text-red-500 font-bold">*</span></li>
            <li>Description <span class="text-red-500 font-bold">*</span></li>
            <li>Qty <span class="text-red-500 font-bold">*</span></li>
            <li>Unit Price <span class="text-red-500 font-bold">*</span></li>
            <li>Discount <span class="text-red-500 font-bold">*</span></li>
            <li>Tax Rate <span class="text-red-500 font-bold">*</span></li>
            <li>Notes <span class="text-red-500 font-bold">*</span></li>
          </ul>
        </div>
      </div>
    </div>

    <div
      class="p-5 bg-white border-b border-border-soft space-y-4"
      formGroupName="meta"
    >
      <h2 class="text-xs font-bold uppercase tracking-wider text-primary">
        Invoice Details
      </h2>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">

        <!-- Invoice ID -->
        <div>
          <label class="text-[10px] uppercase font-bold text-text-muted">
            Invoice ID <span class="text-red-500">*</span>
          </label>
          <input
            formControlName="invoiceNumber"
            placeholder="INV-001"
            class="w-full text-sm bg-bg-soft border border-border-soft
                  rounded-lg p-2.5
                  focus:ring-2 focus:ring-primary/30
                  focus:border-primary transition"
            [class.border-red-500]="isInvalid('meta.invoiceNumber')"
          />
          <div *ngIf="isInvalid('meta.invoiceNumber')" class="error-text">
            Invoice ID is required
          </div>
        </div>

        <!-- Invoice Date -->
        <div>
          <label class="text-[10px] uppercase font-bold text-text-muted">
            Invoice Date <span class="text-red-500">*</span>
          </label>
          <input
            type="date"
            formControlName="invoiceDate"
            class="w-full text-sm bg-bg-soft border border-border-soft
                  rounded-lg p-2.5
                  focus:ring-2 focus:ring-primary/30
                  focus:border-primary transition"
            [class.border-red-500]="isInvalid('meta.invoiceDate')"
          />
          <div *ngIf="isInvalid('meta.invoiceDate')" class="error-text">
            Invoice date is required
          </div>
        </div>

        <!-- Due Date -->
        <div>
          <label class="text-[10px] uppercase font-bold text-text-muted">
            Due Date <span class="text-red-500">*</span>
          </label>
          <input
            type="date"
            formControlName="dueDate"
            class="w-full text-sm bg-bg-soft border border-border-soft
                  rounded-lg p-2.5
                  focus:ring-2 focus:ring-primary/30
                  focus:border-primary transition"
            [class.border-red-500]="isInvalid('meta.dueDate')"
          />
          <div *ngIf="isInvalid('meta.dueDate')" class="error-text">
            Due date is required
          </div>
        </div>

      </div>
    </div>

    <!-- =========================
         YOUR BUSINESS
    ========================== -->
    <div class="relative p-5 bg-white border-b border-border-soft" formGroupName="company">
      <span class="absolute left-0 top-0 h-full w-1 bg-primary rounded-r"></span>

      <div class="flex justify-between gap-6">
        <div class="flex-1 space-y-3 pl-3">
          <h2 class="text-xs font-bold uppercase tracking-wider text-primary">
            Your Business
          </h2>

          <input
            formControlName="name"
            placeholder="Company Name *"
            class="w-full bg-transparent border-none p-0
                   text-xl font-bold placeholder:text-text-muted
                   focus:ring-0"
            [class.border-red-500]="isInvalid('company.name')"
          />
          <div *ngIf="isInvalid('company.name')" class="error-text">
            Company name is required
          </div>

          <input
            formControlName="email"
            placeholder="Email Address *"
            type="email"
            class="w-full bg-transparent border-none p-0
                   text-sm placeholder:text-text-muted
                   focus:ring-0"
            [class.border-red-500]="isInvalid('company.email')"
          />
          <div *ngIf="isInvalid('company.email')" class="error-text">
            Valid email is required
          </div>

          <input
            formControlName="website"
            placeholder="Website *"
            class="w-full bg-transparent border-none p-0
                   text-sm placeholder:text-text-muted
                   focus:ring-0"
            [class.border-red-500]="isInvalid('company.website')"
          />
          <div *ngIf="isInvalid('company.website')" class="error-text">
            Website is required
          </div>
        </div>

        <!-- Logo -->
        <div class="w-24">
          <label class="text-[10px] uppercase font-bold text-text-muted">
            Logo <span class="text-red-500">*</span>
          </label>

          <label
            class="mt-2 w-24 h-24 border-2 border-dashed border-border-soft rounded-xl
                  flex flex-col items-center justify-center text-text-muted bg-bg-soft
                  hover:border-primary hover:text-primary transition cursor-pointer overflow-hidden"
          >
            <input
              type="file"
              accept="image/*"
              class="hidden"
              (change)="onLogoSelected($event)"
            />

            <!-- preview -->
            <ng-container *ngIf="companyLogoDataUrl; else placeholder">
              <img [src]="companyLogoDataUrl" class="w-full h-full object-contain bg-white" />
            </ng-container>

            <ng-template #placeholder>
              <span class="material-symbols-outlined mb-1">add_a_photo</span>
              <span class="text-[10px] font-medium">Add Logo</span>
            </ng-template>
          </label>

          <button
            *ngIf="companyLogoDataUrl"
            type="button"
            class="mt-2 text-xs text-red-600 underline"
            (click)="clearLogo()"
          >
            Remove
          </button>
        </div>

      </div>

      <div class="mt-4 space-y-3 pl-3">
        <input
          formControlName="address"
          placeholder="Street Address *"
          class="w-full text-sm bg-bg-soft border border-border-soft
                 rounded-lg p-2.5
                 focus:ring-2 focus:ring-primary/30
                 focus:border-primary transition"
          [class.border-red-500]="isInvalid('company.address')"
        />
        <div *ngIf="isInvalid('company.address')" class="error-text">
          Address is required
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <input
              formControlName="country"
              placeholder="Country *"
              class="w-full text-sm bg-bg-soft border border-border-soft
                     rounded-lg p-2.5
                     focus:ring-2 focus:ring-primary/30
                     focus:border-primary transition"
              [class.border-red-500]="isInvalid('company.country')"
            />
            <div *ngIf="isInvalid('company.country')" class="error-text">
              Country is required
            </div>
          </div>

          <div>
            <input
              formControlName="zip"
              placeholder="ZIP Code *"
              class="w-full text-sm bg-bg-soft border border-border-soft
                     rounded-lg p-2.5
                     focus:ring-2 focus:ring-primary/30
                     focus:border-primary transition"
              [class.border-red-500]="isInvalid('company.zip')"
            />
            <div *ngIf="isInvalid('company.zip')" class="error-text">
              ZIP code is required
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- =========================
         BILL TO
    ========================== -->
    <div class="p-5 bg-white border-b border-border-soft space-y-4" formGroupName="client">
      <h2 class="text-xs font-bold uppercase tracking-wider text-primary">
        Bill To
      </h2>

      <input
        formControlName="name"
        placeholder="Client Name *"
        class="w-full text-base font-semibold bg-bg-soft
               border border-border-soft rounded-lg p-3
               focus:ring-2 focus:ring-primary/30
               focus:border-primary transition"
        [class.border-red-500]="isInvalid('client.name')"
      />
      <div *ngIf="isInvalid('client.name')" class="error-text">
        Client name is required
      </div>

      <textarea
        formControlName="address"
        rows="2"
        placeholder="Client Address *"
        class="w-full text-sm bg-bg-soft
               border border-border-soft rounded-lg p-3
               focus:ring-2 focus:ring-primary/30
               focus:border-primary transition"
        [class.border-red-500]="isInvalid('client.address')"
      ></textarea>
      <div *ngIf="isInvalid('client.address')" class="error-text">
        Client address is required
      </div>

      <input
        formControlName="email"
        type="email"
        placeholder="Client Email *"
        class="w-full text-sm bg-bg-soft
               border border-border-soft rounded-lg p-3
               focus:ring-2 focus:ring-primary/30
               focus:border-primary transition"
        [class.border-red-500]="isInvalid('client.email')"
      />
      <div *ngIf="isInvalid('client.email')" class="error-text">
        Valid client email is required
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <input
            formControlName="country"
            placeholder="Country *"
            class="w-full text-sm bg-bg-soft border border-border-soft
                   rounded-lg p-2.5
                   focus:ring-2 focus:ring-primary/30
                   focus:border-primary transition"
            [class.border-red-500]="isInvalid('client.country')"
          />
          <div *ngIf="isInvalid('client.country')" class="error-text">
            Country is required
          </div>
        </div>

        <div>
          <input
            formControlName="cityStateZip"
            placeholder="City, State ZIP *"
            class="w-full text-sm bg-bg-soft border border-border-soft
                   rounded-lg p-2.5
                   focus:ring-2 focus:ring-primary/30
                   focus:border-primary transition"
            [class.border-red-500]="isInvalid('client.cityStateZip')"
          />
          <div *ngIf="isInvalid('client.cityStateZip')" class="error-text">
            City/State/ZIP is required
          </div>
        </div>
      </div>
    </div>

    <!-- =========================
         INVOICE ITEMS
    ========================== -->
    <div class="p-5 bg-bg-soft space-y-4" formArrayName="items">
      <div class="flex items-center justify-between">
        <h2 class="text-xs font-bold uppercase tracking-wider text-primary">
          Invoice Items
        </h2>
        <span class="text-xs text-slate-500">
          All item fields are required <span class="text-red-500 font-bold">*</span>
        </span>
      </div>

      <div
        *ngFor="let item of items.controls; let i = index"
        [formGroupName]="i"
        class="bg-white p-4 rounded-xl border border-border-soft
               shadow-sm hover:shadow-md transition space-y-4"
      >
        <!-- Description + Delete -->
        <div class="flex justify-between items-start gap-4">
          <div class="flex-1">
            <label class="text-[10px] uppercase font-bold text-text-muted">
              Description <span class="text-red-500 font-bold">*</span>
            </label>
            <input
              formControlName="description"
              placeholder="Item description *"
              class="w-full font-semibold border-none p-0
                     bg-transparent focus:ring-0"
              [class.border-red-500]="isInvalid('items.' + i + '.description')"
            />
            <div *ngIf="isInvalid('items.' + i + '.description')" class="error-text">
              Description is required
            </div>
          </div>

          <button type="button" (click)="removeItem(i)">
            <span class="material-symbols-outlined text-text-muted text-sm">
              delete
            </span>
          </button>
        </div>

        <!-- Main numeric fields -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div>
            <label class="text-[10px] uppercase font-bold text-text-muted">
              Qty <span class="text-red-500 font-bold">*</span>
            </label>
            <input
              type="number"
              formControlName="quantity"
              class="input-soft"
              [class.border-red-500]="isInvalid('items.' + i + '.quantity')"
            />
            <div *ngIf="isInvalid('items.' + i + '.quantity')" class="error-text">
              Qty must be greater than 0
            </div>
          </div>

          <div>
            <label class="text-[10px] uppercase font-bold text-text-muted">
              Unit Price <span class="text-red-500 font-bold">*</span>
            </label>
            <input
              type="number"
              formControlName="unitPrice"
              class="input-soft"
              [class.border-red-500]="isInvalid('items.' + i + '.unitPrice')"
            />
            <div *ngIf="isInvalid('items.' + i + '.unitPrice')" class="error-text">
              Unit price is required
            </div>
          </div>

          <div>
            <label class="text-[10px] uppercase font-bold text-text-muted">
              Discount <span class="text-red-500 font-bold">*</span>
            </label>
            <input
              type="number"
              formControlName="discount"
              class="input-soft"
              [class.border-red-500]="isInvalid('items.' + i + '.discount')"
            />
            <div *ngIf="isInvalid('items.' + i + '.discount')" class="error-text">
              Discount is required
            </div>
          </div>

          <div>
            <label class="text-[10px] uppercase font-bold text-text-muted">
              Tax Rate <span class="text-red-500 font-bold">*</span>
            </label>
            <input
              type="number"
              formControlName="taxRate"
              class="input-soft"
              [class.border-red-500]="isInvalid('items.' + i + '.taxRate')"
            />
            <div *ngIf="isInvalid('items.' + i + '.taxRate')" class="error-text">
              Tax rate is required (0 to 1)
            </div>
          </div>
        </div>

        <!-- Item type -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-1">
          <div>
            <label class="text-[10px] uppercase font-bold text-text-muted">
              Item Type <span class="text-red-500 font-bold">*</span>
            </label>
            <select
              formControlName="type"
              class="input-soft"
              [class.border-red-500]="isInvalid('items.' + i + '.type')"
            >
              <option value="SERVICE">Service</option>
              <option value="PRODUCT">Product</option>
            </select>
            <div *ngIf="isInvalid('items.' + i + '.type')" class="error-text">
              Item type is required
            </div>
          </div>
        </div>
      </div>

      <!-- Add item -->
      <button
        type="button"
        (click)="addItem()"
        class="w-full py-3 border-2 border-dashed
               border-primary/40 rounded-xl
               text-primary font-semibold text-sm
               hover:bg-primary/5 transition"
      >
        + Add Line Item
      </button>
    </div>

    <!-- =========================
         NOTES
    ========================== -->
    <div class="p-5 bg-white border-t border-border-soft">
      <label
        class="text-[10px] font-bold uppercase tracking-wider text-primary block mb-2"
      >
        Notes & Terms <span class="text-red-500 font-bold">*</span>
      </label>

      <textarea
        formControlName="notes"
        rows="3"
        placeholder="Notes & terms *"
        class="
          w-full
          text-sm
          bg-bg-soft
          border
          border-border-soft
          rounded-lg
          p-3
          focus:ring-2
          focus:ring-primary/30
          focus:border-primary
          transition
        "
        [class.border-red-500]="isInvalid('notes')"
      ></textarea>
      <div *ngIf="isInvalid('notes')" class="error-text">
        Notes are required
      </div>
    </div>

  </form>

  <!-- =========================
       STICKY TOTALS BAR
  ========================== -->
  <div
    class="fixed bottom-0 left-0 right-0 z-50
           bg-white border-t border-slate-200
           p-4 pb-8 shadow-[0_-10px_15px_-3px_rgba(0,0,0,0.1)]"
  >
    <div class="max-w-4xl mx-auto space-y-4">

      <div class="space-y-1 text-sm">
        <div class="flex justify-between text-slate-500">
          <span>Subtotal</span>
          <span>{{ totals.subtotal | currency:'USD' }}</span>
        </div>

        <div class="flex justify-between text-slate-500">
          <span>Tax</span>
          <span>{{ totals.taxTotal | currency:'USD' }}</span>
        </div>

        <div class="flex justify-between text-slate-500">
          <span>Discount</span>
          <span>{{ totals.discountTotal | currency:'USD' }}</span>
        </div>

        <div class="flex justify-between text-lg font-bold pt-1">
          <span>Total</span>
          <span class="text-primary">
            {{ totals.total | currency:'USD' }}
          </span>
        </div>
      </div>

      <button
        type="button"
        (click)="generatePdf()"
        [disabled]="form.invalid || !!apiErrorMessage"
        class="w-full bg-primary text-white py-4 rounded-xl font-bold shadow-lg shadow-primary/30
              flex items-center justify-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed"
      >
        Generate Invoice PDF
      </button>

    </div>
  </div>

</div>
